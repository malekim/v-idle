{"version":3,"file":"vidle.esm.js","sources":["../src/components/vidle.ts"],"sourcesContent":["import {\n  h,\n  nextTick,\n  ref,\n  defineComponent,\n  type PropType,\n  type Ref,\n  onMounted,\n  onBeforeUnmount,\n} from 'vue-demi'\n\ntype ClearEvent = {\n  type: string\n  key: string | undefined\n}\n\nexport default defineComponent({\n  emits: ['idle', 'remind', 'refresh'],\n  props: {\n    duration: {\n      type: Number,\n      // default 5 minutes\n      default: 60 * 5,\n    },\n    events: {\n      type: Array as PropType<string[]>,\n      default: (): string[] => ['mousemove', 'keypress'],\n    },\n    loop: {\n      type: Boolean,\n      default: false,\n    },\n    syncKey: {\n      type: String,\n      default: '',\n    },\n    reminders: {\n      type: Array as PropType<number[]>,\n      // array of seconds\n      // emit \"remind\" event on each second\n      default: (): number[] => [],\n    },\n    wait: {\n      type: Number,\n      default: 0,\n    },\n  },\n  setup: (props, { emit }) => {\n    const display: Ref<string> = ref('')\n    const timer: Ref<number | undefined> = ref(undefined)\n    const start: Ref<number> = ref(0)\n    const counter: Ref<number | undefined> = ref(undefined)\n    const diff: Ref<number> = ref(0)\n    const minutes: Ref<string> = ref('')\n    const seconds: Ref<string> = ref('')\n    const broadcastChannel: Ref<BroadcastChannel | undefined> = ref(undefined)\n\n    const isSyncEnabled: boolean =\n      props.syncKey.length > 0 &&\n      typeof window !== 'undefined' &&\n      'BroadcastChannel' in window\n\n    const shouldRemind = () => {\n      if (props.reminders.length > 0) {\n        if (props.reminders.includes(diff.value)) {\n          remind()\n        }\n      }\n    }\n\n    const setDisplay = () => {\n      // seconds since start\n      diff.value = props.duration - (((Date.now() - start.value) / 1000) | 0)\n\n      if (diff.value < 0 && !props.loop) {\n        clearInterval(timer.value)\n        clearInterval(counter.value)\n        return\n      }\n      shouldRemind()\n\n      // bitwise OR to handle parseInt\n      const minute = (diff.value / 60) | 0\n      const second = diff.value % 60 | 0\n\n      minutes.value = `${minute < 10 ? '0' + minute : minute}`\n      seconds.value = `${second < 10 ? '0' + second : second}`\n\n      display.value = `${minutes.value}:${seconds.value}`\n    }\n\n    const countdown = () => {\n      setDisplay()\n\n      if (diff.value <= 0 && props.loop) {\n        // add second to start at the full duration\n        // for instance 05:00, not 04:59\n        start.value = Date.now() + 1000\n      }\n    }\n\n    const idle = () => {\n      emit('idle')\n    }\n\n    const remind = () => {\n      emit('remind')\n    }\n\n    const setTimer = () => {\n      timer.value = window.setInterval(idle, props.duration * 1000)\n      counter.value = window.setInterval(countdown, 1000)\n    }\n\n    const clearEvent = (event: Event) => {\n      const clearEvent: ClearEvent = {\n        type: event.type,\n        key: event instanceof KeyboardEvent ? event.key : undefined,\n      }\n      clearTimer(clearEvent)\n      // clearEvent is called only in original tab when sync is on\n      if (isSyncEnabled) {\n        sendBroadcastEvent(clearEvent)\n      }\n    }\n\n    const clearTimer = (clearEvent: ClearEvent) => {\n      emit('refresh', clearEvent)\n      clearInterval(timer.value)\n      clearInterval(counter.value)\n      setDisplay()\n      start.value = Date.now()\n      diff.value = 0\n      setTimer()\n    }\n\n    const sendBroadcastEvent = (event: ClearEvent) => {\n      if (broadcastChannel.value !== undefined) {\n        broadcastChannel.value.postMessage(event)\n      }\n    }\n\n    const setBroadcastChannel = () => {\n      broadcastChannel.value = new BroadcastChannel(props.syncKey)\n      broadcastChannel.value.addEventListener(\n        'message',\n        (event: MessageEvent<ClearEvent>) => {\n          clearTimer(event.data)\n        },\n      )\n    }\n\n    onMounted(() => {\n      if (isSyncEnabled) {\n        setBroadcastChannel()\n      }\n      setTimeout(() => {\n        start.value = Date.now()\n        setDisplay()\n        nextTick(() => {\n          setTimer()\n          for (let i = props.events.length - 1; i >= 0; i -= 1) {\n            window.addEventListener(props.events[i], clearEvent)\n          }\n        })\n      }, props.wait * 1000)\n    })\n\n    onBeforeUnmount(() => {\n      clearInterval(timer.value)\n      clearInterval(counter.value)\n      for (let i = props.events.length - 1; i >= 0; i -= 1) {\n        window.removeEventListener(props.events[i], clearEvent)\n      }\n    })\n\n    return {\n      display,\n    }\n  },\n  render() {\n    return h(\n      'div',\n      {\n        class: 'v-idle',\n      },\n      this.display,\n    )\n  },\n})\n"],"names":[],"mappings":"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"}