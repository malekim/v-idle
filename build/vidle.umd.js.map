{"version":3,"file":"vidle.umd.js","sources":["../src/components/vidle.ts"],"sourcesContent":["import {\n  h,\n  nextTick,\n  ref,\n  defineComponent,\n  type PropType,\n  type Ref,\n  onMounted,\n  onBeforeUnmount,\n} from 'vue-demi'\n\ntype ClearEvent = {\n  type: string\n  key: string | undefined\n}\n\nexport default defineComponent({\n  emits: ['idle', 'remind', 'refresh'],\n  props: {\n    duration: {\n      type: Number,\n      // default 5 minutes\n      default: 60 * 5,\n    },\n    events: {\n      type: Array as PropType<string[]>,\n      default: (): string[] => ['mousemove', 'keypress'],\n    },\n    loop: {\n      type: Boolean,\n      default: false,\n    },\n    syncKey: {\n      type: String,\n      default: '',\n    },\n    reminders: {\n      type: Array as PropType<number[]>,\n      // array of seconds\n      // emit \"remind\" event on each second\n      default: (): number[] => [],\n    },\n    wait: {\n      type: Number,\n      default: 0,\n    },\n  },\n  setup: (props, { emit }) => {\n    const display: Ref<string> = ref('')\n    const timer: Ref<number | undefined> = ref(undefined)\n    const start: Ref<number> = ref(0)\n    const counter: Ref<number | undefined> = ref(undefined)\n    const diff: Ref<number> = ref(0)\n    const minutes: Ref<string> = ref('')\n    const seconds: Ref<string> = ref('')\n    const broadcastChannel: Ref<BroadcastChannel | undefined> = ref(undefined)\n\n    const isSyncEnabled: boolean =\n      props.syncKey.length > 0 &&\n      typeof window !== 'undefined' &&\n      'BroadcastChannel' in window\n\n    const shouldRemind = () => {\n      if (props.reminders.length > 0) {\n        if (props.reminders.includes(diff.value)) {\n          remind()\n        }\n      }\n    }\n\n    const setDisplay = () => {\n      // seconds since start\n      diff.value = props.duration - (((Date.now() - start.value) / 1000) | 0)\n\n      if (diff.value < 0 && !props.loop) {\n        clearInterval(timer.value)\n        clearInterval(counter.value)\n        return\n      }\n      shouldRemind()\n\n      // bitwise OR to handle parseInt\n      const minute = (diff.value / 60) | 0\n      const second = diff.value % 60 | 0\n\n      minutes.value = `${minute < 10 ? '0' + minute : minute}`\n      seconds.value = `${second < 10 ? '0' + second : second}`\n\n      display.value = `${minutes.value}:${seconds.value}`\n    }\n\n    const countdown = () => {\n      setDisplay()\n\n      if (diff.value <= 0 && props.loop) {\n        // add second to start at the full duration\n        // for instance 05:00, not 04:59\n        start.value = Date.now() + 1000\n      }\n    }\n\n    const idle = () => {\n      emit('idle')\n    }\n\n    const remind = () => {\n      emit('remind')\n    }\n\n    const setTimer = () => {\n      timer.value = window.setInterval(idle, props.duration * 1000)\n      counter.value = window.setInterval(countdown, 1000)\n    }\n\n    const clearEvent = (event: Event) => {\n      const clearEvent: ClearEvent = {\n        type: event.type,\n        key: event instanceof KeyboardEvent ? event.key : undefined,\n      }\n      clearTimer(clearEvent)\n      // clearEvent is called only in original tab when sync is on\n      if (isSyncEnabled) {\n        sendBroadcastEvent(clearEvent)\n      }\n    }\n\n    const clearTimer = (clearEvent: ClearEvent) => {\n      emit('refresh', clearEvent)\n      clearInterval(timer.value)\n      clearInterval(counter.value)\n      setDisplay()\n      start.value = Date.now()\n      diff.value = 0\n      setTimer()\n    }\n\n    const sendBroadcastEvent = (event: ClearEvent) => {\n      if (broadcastChannel.value !== undefined) {\n        broadcastChannel.value.postMessage(event)\n      }\n    }\n\n    const setBroadcastChannel = () => {\n      broadcastChannel.value = new BroadcastChannel(props.syncKey)\n      broadcastChannel.value.addEventListener(\n        'message',\n        (event: MessageEvent<ClearEvent>) => {\n          clearTimer(event.data)\n        },\n      )\n    }\n\n    onMounted(() => {\n      if (isSyncEnabled) {\n        setBroadcastChannel()\n      }\n      setTimeout(() => {\n        start.value = Date.now()\n        setDisplay()\n        nextTick(() => {\n          setTimer()\n          for (let i = props.events.length - 1; i >= 0; i -= 1) {\n            window.addEventListener(props.events[i], clearEvent)\n          }\n        })\n      }, props.wait * 1000)\n    })\n\n    onBeforeUnmount(() => {\n      clearInterval(timer.value)\n      clearInterval(counter.value)\n      for (let i = props.events.length - 1; i >= 0; i -= 1) {\n        window.removeEventListener(props.events[i], clearEvent)\n      }\n    })\n\n    return {\n      display,\n    }\n  },\n  render() {\n    return h(\n      'div',\n      {\n        class: 'v-idle',\n      },\n      this.display,\n    )\n  },\n})\n"],"names":["defineComponent","ref","onMounted","nextTick","onBeforeUnmount","h"],"mappings":"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"}